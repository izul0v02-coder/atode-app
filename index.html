<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚ã¨ã§</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
  :root{--bg:#e8e8e8;--bg2:#dcdcdc;--card:#f4f4f4;--card-done:#d8d8d8;--text:#111;--text-sub:#888;--border:#d0d0d0;--shadow:rgba(0,0,0,.07);--accent:#111;--al:#444;--ap:#e0e0e0;--ab:#eeeeee;--dc:#111;}
  [data-theme="mono"]{--bg:#e8e8e8;--bg2:#dcdcdc;--card:#f4f4f4;--card-done:#d8d8d8;--text:#111;--text-sub:#888;--border:#d0d0d0;--shadow:rgba(0,0,0,.07);--accent:#b8c400;--al:#ccda00;--ap:#eef590;--ab:#f5fac0;--dc:#b8c400;}
  [data-theme="natural"]{--bg:#eeecea;--bg2:#e4e2de;--card:#f8f7f5;--card-done:#e4e2de;--text:#1a1a18;--text-sub:#8a8a84;--border:#dddbd6;--shadow:rgba(0,0,0,.06);--accent:#e05040;--al:#ec7a6e;--ap:#fbd8d4;--ab:#fff4f3;--dc:#e05040;}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{background:var(--bg);font-family:'Noto Sans JP',sans-serif;color:var(--text);min-height:100vh;display:flex;justify-content:center;transition:background .4s,color .4s;}
  .app{width:100%;max-width:480px;min-height:100vh;background:var(--bg);display:flex;flex-direction:column;padding-bottom:90px;transition:background .4s;}
  /* Header */
  .header{background:var(--bg);padding:20px 20px 0;position:sticky;top:0;z-index:100;transition:background .4s;}
  .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
  .title-area{display:flex;align-items:center;gap:10px;}
  .app-title{font-family:'DM Sans',sans-serif;font-size:26px;font-weight:700;color:var(--text);letter-spacing:-.5px;}
  .title-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--accent);margin-left:1px;margin-bottom:5px;vertical-align:bottom;transition:background .4s;}
  .task-count{font-size:12px;font-weight:500;color:var(--text-sub);background:var(--bg2);border-radius:20px;padding:2px 10px;}
  .header-actions{display:flex;align-items:center;gap:8px;}
  .sort-btn{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:6px 12px;font-size:12px;color:var(--text-sub);cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .2s;display:flex;align-items:center;gap:4px;}
  .sort-btn.active{background:var(--text);color:var(--bg);border-color:var(--text);}
  .add-btn{background:var(--accent);border:none;border-radius:20px;width:36px;height:36px;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(0,0,0,.15);transition:transform .15s,background .4s;flex-shrink:0;}
  .add-btn:active{transform:scale(.93);}
  .theme-btn{width:30px;height:30px;border-radius:50%;border:2px solid var(--border);background:var(--card);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:'DM Sans',sans-serif;font-weight:700;color:var(--text-sub);}
  /* Theme panel */
  .theme-panel{position:fixed;top:62px;right:calc(50% - min(240px,50% - 16px));background:var(--card);border:1px solid var(--border);border-radius:18px;padding:8px 10px;box-shadow:0 8px 28px var(--shadow);z-index:400;display:none;flex-direction:row;gap:6px;align-items:center;transition:background .4s;}
  .theme-panel.open{display:flex;}
  .theme-option{padding:3px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all .18s;}
  .theme-option.active{border-color:var(--accent);}
  .theme-dot{width:24px;height:24px;border-radius:50%;border:1.5px solid rgba(0,0,0,.1);}
  /* Tabs */
  .tabs{display:flex;gap:4px;padding:8px 16px 10px;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
  .tabs::-webkit-scrollbar{display:none;}
  .tab{padding:5px 12px;border-radius:20px;font-size:12px;white-space:nowrap;cursor:pointer;border:none;font-family:'Noto Sans JP',sans-serif;transition:all .2s;background:transparent;color:var(--text-sub);flex-shrink:0;}
  .tab.active{background:var(--accent);color:#fff;}
  /* Habit */
  .habit-section{padding:14px 16px 0;}
  .habit-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
  .habit-month-btn{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--text-sub);background:transparent;border:1px solid var(--border);border-radius:10px;padding:3px 10px;cursor:pointer;letter-spacing:.5px;transition:all .2s;}
  .habit-month-btn:hover{background:var(--bg2);color:var(--text);}
  .habit-manage-btn{font-size:11px;color:var(--text-sub);background:transparent;border:none;cursor:pointer;padding:3px 6px;font-family:'Noto Sans JP',sans-serif;}
  .habit-table{width:100%;border-collapse:separate;border-spacing:0;}
  .habit-table th{font-size:9px;color:var(--text-sub);font-weight:500;text-align:center;padding-bottom:4px;}
  .habit-lbl-cell{width:56px;padding-right:6px;}
  .habit-lbl-inner{display:flex;flex-direction:column;align-items:flex-end;width:52px;}
  .habit-emoji{display:none;}
  .habit-name-txt{font-size:9px;color:var(--text-sub);max-width:52px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;}
  .habit-dot-cell{text-align:center;padding:5px 1px;}
  .h-dot{width:11px;height:11px;border-radius:50%;background:var(--bg2);border:1.5px solid var(--border);cursor:pointer;transition:all .18s;display:inline-block;}
  .h-dot.today-dot{border-color:var(--dc,var(--accent));border-width:2px;}
  .h-dot.checked{background:var(--dc,var(--accent));border-color:var(--dc,var(--accent));}
  .h-dot.future{opacity:.2;cursor:default;pointer-events:none;}
  .habit-date-row td{font-size:9px;color:var(--text-sub);text-align:center;padding-bottom:4px;}
  .habit-date-today{color:var(--accent);font-weight:700;}
  /* Task list */
  .list{flex:1;padding:4px 16px 20px;}
  .date-heading{font-size:11px;font-weight:600;color:var(--accent);letter-spacing:1px;padding:16px 4px 8px;display:flex;align-items:center;gap:8px;}
  .date-heading::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--ap),transparent);}
  .task-card{background:var(--card);border-radius:14px;padding:12px 38px 12px 12px;margin-bottom:7px;border:1px solid var(--border);border-left:3px solid transparent;box-shadow:0 1px 6px var(--shadow);display:flex;gap:10px;align-items:flex-start;transition:all .3s;position:relative;cursor:pointer;}
  .task-card:active{transform:scale(.98);}
  .task-card.urgent{border-left-color:var(--accent);background:linear-gradient(135deg,var(--ab) 0%,var(--card) 60%);}
  .task-card.done{background:var(--card-done);opacity:.55;box-shadow:none;border-left-color:transparent!important;}
  .task-card.done .task-title{text-decoration:line-through;color:var(--text-sub);}
  .card-del-btn{position:absolute;right:8px;bottom:7px;width:24px;height:24px;border-radius:50%;background:transparent;border:none;color:var(--text-sub);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.35;transition:all .2s;}
  .card-del-btn:hover{background:rgba(220,50,50,.1);color:#e04040;opacity:1;}
  .cb-wrap{position:relative;flex-shrink:0;width:20px;height:20px;margin-top:2px;}
  .cb{width:20px;height:20px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;background:transparent;}
  .task-card.urgent .cb{border-color:var(--al);}
  .cb.checked{background:var(--accent);border-color:var(--accent);animation:pop .22s ease;}
  @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
  .cb svg{display:none;}.cb.checked svg{display:block;}
  .sp-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:20;}
  .sp{position:absolute;opacity:0;border-radius:50%;}
  .sp.star{border-radius:0;clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);}
  .sp.active{animation:sfly .75s cubic-bezier(.25,.46,.45,.94) forwards;}
  @keyframes sfly{0%{transform:translate(0,0) scale(1.2);opacity:1}40%{opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0) rotate(var(--rot));opacity:0}}
  .praise{position:absolute;left:10px;bottom:26px;transform:translateX(-8px);background:var(--text);color:var(--bg);font-size:12px;font-weight:700;padding:4px 10px;border-radius:18px;white-space:nowrap;pointer-events:none;z-index:50;animation:pbop 1.6s ease forwards;}
  .praise::after{content:'';position:absolute;left:10px;bottom:-5px;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid var(--text);}
  @keyframes pbop{0%{opacity:0;transform:translateX(-8px) scale(.7) translateY(4px)}12%{opacity:1;transform:translateX(-8px) scale(1.05) translateY(-1px)}22%{transform:translateX(-8px) scale(1)}70%{opacity:1;transform:translateX(-8px) translateY(-4px)}100%{opacity:0;transform:translateX(-8px) translateY(-14px)}}
  .urgent-mark{font-size:15px;color:var(--accent);font-weight:800;flex-shrink:0;margin-top:2px;}
  .task-content{flex:1;min-width:0;}
  .task-header{display:flex;justify-content:space-between;align-items:flex-start;gap:6px;}
  .task-title{font-size:14px;font-weight:500;color:var(--text);line-height:1.4;flex:1;}
  .task-date{font-size:13px;font-weight:700;color:var(--accent);white-space:nowrap;flex-shrink:0;}
  .task-meta{display:flex;align-items:center;gap:8px;margin-top:3px;}
  .time-chip{font-size:11px;color:var(--text-sub);background:var(--bg2);border-radius:8px;padding:1px 6px;}
  .notif-icon{font-size:11px;cursor:pointer;opacity:.5;transition:opacity .2s;}
  .notif-icon.on{opacity:1;}
  .task-memo{font-size:12px;color:var(--text-sub);margin-top:5px;line-height:1.5;}
  .task-tags{display:flex;gap:4px;margin-top:6px;}
  .tag{background:var(--ap);border-radius:8px;padding:2px 7px;font-size:10px;color:var(--accent);font-weight:500;}
  .notif-banner{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--text);color:var(--bg);padding:10px 18px;border-radius:14px;z-index:9999;font-size:14px;font-weight:500;max-width:320px;width:90%;transition:transform .4s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:8px;}
  .notif-banner.show{transform:translateX(-50%) translateY(0);}
  .empty{text-align:center;padding:50px 20px;color:var(--text-sub);font-size:14px;}
  .empty-icon{font-size:36px;margin-bottom:10px;opacity:.4;}
  /* Bottom bar */
  .bottom-bar{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:1px solid var(--border);padding:10px 16px 24px;z-index:200;box-shadow:0 -4px 16px var(--shadow);transition:background .4s;}
  .bottom-add-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:14px;padding:13px;font-size:15px;font-weight:600;cursor:pointer;font-family:'Noto Sans JP',sans-serif;display:flex;align-items:center;justify-content:center;gap:6px;transition:filter .2s,transform .1s;}
  .bottom-add-btn:active{transform:scale(.98);}
  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .22s;padding:20px;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--card);border-radius:22px;padding:22px 20px;width:100%;max-width:420px;transform:translateY(18px) scale(.97);transition:transform .3s cubic-bezier(.34,1.56,.64,1),background .4s;box-shadow:0 14px 50px rgba(0,0,0,.18);max-height:90vh;overflow-y:auto;}
  .modal-overlay.open .modal{transform:translateY(0) scale(1);}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
  .modal h3{font-size:16px;font-weight:700;color:var(--text);}
  .modal-close{background:var(--bg2);border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:13px;color:var(--text-sub);display:flex;align-items:center;justify-content:center;}
  .form-group{margin-bottom:12px;}
  .form-label{font-size:11px;color:var(--text-sub);margin-bottom:4px;font-weight:500;}
  .form-input,.form-textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px;color:var(--text);font-family:'Noto Sans JP',sans-serif;outline:none;transition:border-color .2s,background .4s;}
  .form-input:focus,.form-textarea:focus{border-color:var(--al);}
  .form-textarea{resize:none;height:64px;overflow:hidden;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .notif-row{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;}
  .notif-row.on{background:var(--ap);border-color:var(--al);}
  .notif-row-label{font-size:13px;color:var(--text-sub);flex:1;}
  .notif-row.on .notif-row-label{color:var(--accent);font-weight:500;}
  .tsw{width:34px;height:19px;background:var(--border);border-radius:10px;position:relative;transition:background .2s;flex-shrink:0;}
  .tsw::after{content:'';width:15px;height:15px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.15);}
  .notif-row.on .tsw{background:var(--accent);}
  .notif-row.on .tsw::after{transform:translateX(15px);}
  .urgent-toggle{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;height:40px;}
  .urgent-toggle.on{background:var(--ap);border-color:var(--al);}
  .utl{font-size:13px;color:var(--text-sub);flex:1;}
  .urgent-toggle.on .utl{color:var(--accent);font-weight:600;}
  .urgent-toggle.on .tsw{background:var(--accent);}
  .urgent-toggle.on .tsw::after{transform:translateX(15px);}
  .tag-selector{display:flex;flex-wrap:wrap;gap:5px;}
  .tag-option{padding:4px 10px;border-radius:18px;font-size:12px;border:1.5px solid var(--border);background:var(--bg);color:var(--text-sub);cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .15s;}
  .tag-option.selected{background:var(--ap);border-color:var(--al);color:var(--accent);font-weight:500;}
  .tag-option.add-tag{border-style:dashed;}
  .tag-custom-input{display:none;width:100%;margin-top:5px;}
  .tag-custom-input.visible{display:block;}
  .btn-submit{width:100%;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-top:4px;transition:filter .2s;}
  .btn-del-task{width:100%;background:transparent;color:#e04040;border:1.5px solid #e04040;border-radius:12px;padding:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-top:6px;}
  .notif-hint{font-size:11px;color:var(--al);margin-top:4px;display:none;}
  .notif-hint.visible{display:block;}
  /* Confirm */
  .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;padding:20px;}
  .confirm-overlay.open{opacity:1;pointer-events:all;}
  .confirm-box{background:var(--card);border-radius:18px;padding:22px 20px;width:100%;max-width:300px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.18);transform:scale(.9);transition:transform .22s cubic-bezier(.34,1.56,.64,1),background .4s;}
  .confirm-overlay.open .confirm-box{transform:scale(1);}
  .ci{font-size:32px;margin-bottom:8px;}
  .ct{font-size:15px;font-weight:700;color:var(--text);margin-bottom:5px;}
  .cs{font-size:12px;color:var(--text-sub);margin-bottom:18px;line-height:1.5;}
  .cb-btns{display:flex;gap:8px;}
  .cc{flex:1;background:var(--bg2);border:none;border-radius:10px;padding:11px;font-size:13px;color:var(--text-sub);cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
  .cd{flex:1;background:#e04040;border:none;border-radius:10px;padding:11px;font-size:13px;color:#fff;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-weight:600;}
  /* Sheet */
  .sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:400;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
  .sheet-overlay.open{opacity:1;pointer-events:all;}
  .sheet{background:var(--card);border-radius:22px 22px 0 0;width:100%;max-width:480px;padding:14px 16px 40px;transform:translateY(100%);transition:transform .32s cubic-bezier(.34,1.2,.64,1),background .4s;max-height:85vh;overflow-y:auto;}
  .sheet-overlay.open .sheet{transform:translateY(0);}
  .sh{width:34px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 14px;}
  .sheet-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
  .sheet-title{font-size:15px;font-weight:700;color:var(--text);}
  .sheet-close{background:var(--bg2);border:none;border-radius:50%;width:28px;height:28px;font-size:13px;color:var(--text-sub);cursor:pointer;display:flex;align-items:center;justify-content:center;}
  .hi-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
  .hi-row:last-child{border-bottom:none;}
  .hi-dh{color:var(--text-sub);font-size:16px;cursor:grab;padding:0 2px;touch-action:none;}
  .hi-em{font-size:20px;}.hi-nm{flex:1;font-size:14px;color:var(--text);}
  .hi-name-input{flex:1;border:none;background:transparent;font-size:14px;color:var(--text);font-family:'Noto Sans JP',sans-serif;outline:none;padding:2px 4px;border-radius:4px;}
  .hi-name-input:focus{background:var(--bg2);}
  .hi-arrow{background:none;border:none;color:var(--text-sub);font-size:13px;cursor:pointer;padding:2px 5px;opacity:.6;line-height:1;}
  .hi-arrow:hover{opacity:1;color:var(--accent);}
  .hi-arrows{display:flex;flex-direction:column;gap:0;}
  .hi-del{background:none;border:none;color:var(--text-sub);font-size:16px;cursor:pointer;padding:4px;opacity:.5;}
  .hi-del:hover{opacity:1;color:#e04040;}
  .add-hr{display:flex;gap:8px;margin-top:14px;}
  .add-em-btn{width:46px;font-size:20px;text-align:center;border:1px solid var(--border);border-radius:10px;background:var(--bg);cursor:pointer;flex-shrink:0;}
  .add-nm-inp{flex:1;}
  .add-btn-s{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:0 14px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Noto Sans JP',sans-serif;white-space:nowrap;}
  /* Emoji */
  .emo-overlay{position:fixed;inset:0;z-index:600;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);}
  .emo-overlay.open{display:flex;}
  .emo-box{background:var(--card);border-radius:18px;padding:16px;max-width:300px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,.2);}
  .emo-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;}
  .emo-cell{font-size:22px;text-align:center;padding:5px;border-radius:8px;cursor:pointer;transition:background .15s;}
  .emo-cell:hover{background:var(--bg2);}
  /* Graph */
  .graph-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:400;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
  .graph-overlay.open{opacity:1;pointer-events:all;}
  .graph-sheet{background:var(--card);border-radius:22px 22px 0 0;width:100%;max-width:480px;padding:14px 16px 40px;transform:translateY(100%);transition:transform .32s cubic-bezier(.34,1.2,.64,1),background .4s;max-height:82vh;overflow-y:auto;}
  .graph-overlay.open .graph-sheet{transform:translateY(0);}
  .g-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .g-ml{font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;color:var(--text);}
  .g-nb{background:var(--bg2);border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;color:var(--text-sub);}
  .g-htabs{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;}
  .g-htabs::-webkit-scrollbar{display:none;}
  .g-ht{padding:4px 10px;border-radius:20px;font-size:12px;white-space:nowrap;cursor:pointer;border:1.5px solid var(--border);background:var(--bg2);color:var(--text-sub);flex-shrink:0;transition:all .15s;}
  .g-ht.active{background:var(--accent);color:#fff;border-color:var(--accent);}
  .g-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
  .g-sc{background:var(--bg2);border-radius:12px;padding:10px 8px;text-align:center;}
  .g-sn{font-family:'DM Sans',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
  .g-sl{font-size:10px;color:var(--text-sub);margin-top:1px;}
  .g-cal{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:12px;}
  .g-ch{text-align:center;font-size:9px;color:var(--text-sub);font-weight:600;padding:2px 0 4px;}
  .g-cc{position:relative;display:flex;align-items:center;justify-content:center;padding:3px 0;font-size:11px;color:var(--text-sub);cursor:pointer;user-select:none;}
  .g-cc::before{content:'';position:absolute;width:24px;height:24px;border-radius:50%;transition:background .15s;}
  .g-cc span{position:relative;z-index:1;}
  .g-cc.ck{color:#fff;font-weight:700;}.g-cc.ck::before{background:var(--dc,var(--accent));}
  .g-cc.tc{color:var(--accent);font-weight:700;}.g-cc.tc::before{border:1.5px solid var(--accent);}
  .g-cc.fut{opacity:.35;cursor:default;pointer-events:none;}
  .g-cc.ec{visibility:hidden;cursor:default;pointer-events:none;}
  .g-bt{font-size:10px;color:var(--text-sub);margin-bottom:6px;font-weight:600;letter-spacing:.5px;}
  .g-br{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
  .g-bl{font-size:10px;color:var(--text-sub);width:22px;text-align:right;}
  .g-btr{flex:1;height:7px;background:var(--bg2);border-radius:4px;overflow:hidden;}
  .g-bf{height:100%;background:var(--accent);border-radius:4px;transition:width .5s cubic-bezier(.34,1.2,.64,1);}
  .g-bc{font-size:10px;color:var(--text-sub);width:24px;text-align:right;}

  /* æœˆé–“ã‚µãƒãƒªãƒ¼ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸Šï¼‰ */
  .g-summary{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border-radius:12px;padding:8px 14px;margin-bottom:10px;}
  .g-sum-label{font-size:11px;color:var(--text-sub);}
  .g-sum-val{font-size:13px;font-weight:700;color:var(--accent);}
  /* ç¹°ã‚Šè¿”ã—è¨­å®š */
  .repeat-row{display:flex;gap:6px;flex-wrap:wrap;}
  .repeat-btn{padding:5px 12px;border-radius:20px;font-size:12px;border:1.5px solid var(--border);background:var(--bg);color:var(--text-sub);cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .15s;user-select:none;}
  .repeat-btn.selected{background:var(--ap);border-color:var(--al);color:var(--accent);font-weight:600;}
  .repeat-info{font-size:11px;color:var(--text-sub);margin-top:5px;line-height:1.5;}
  /* ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ãƒãƒƒã‚¸ */
  .repeat-badge{font-size:10px;background:var(--bg2);color:var(--text-sub);border-radius:6px;padding:1px 6px;margin-left:4px;vertical-align:middle;}
  /* ç¿’æ…£ãƒªãƒ³ã‚¯ãƒˆã‚°ãƒ« */
  .habit-link-row{display:none;margin-top:8px;background:var(--bg2);border-radius:10px;padding:8px 12px;}
  .habit-link-row.visible{display:block;}
  .habit-link-label{font-size:11px;color:var(--text-sub);margin-bottom:6px;}
  .habit-link-opts{display:flex;flex-wrap:wrap;gap:5px;}
  .habit-link-btn{padding:4px 10px;border-radius:16px;font-size:11px;border:1.5px solid var(--border);background:var(--bg);color:var(--text-sub);cursor:pointer;transition:all .15s;}
  .habit-link-btn.selected{background:var(--ap);border-color:var(--al);color:var(--accent);font-weight:600;}
  /* habit praise bubble - ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«åŸºæº–ã§è¡¨ç¤º */
  .habit-praise{position:fixed;background:var(--text);color:var(--bg);font-size:12px;font-weight:700;padding:4px 10px;border-radius:18px;white-space:nowrap;pointer-events:none;z-index:9999;animation:pbop 1.6s ease forwards;}
  .habit-praise::after{content:'';position:absolute;left:10px;bottom:-5px;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid var(--text);}
  /* æ™‚é–“ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ */
  .time-quick{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;}
  .time-chip-btn{padding:5px 10px;border-radius:16px;font-size:12px;border:1.5px solid var(--border);background:var(--bg);color:var(--text-sub);cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .15s;}
  .time-chip-btn.selected{background:var(--ap);border-color:var(--al);color:var(--accent);font-weight:600;}
  .time-custom-wrap{display:flex;align-items:center;gap:6px;margin-top:6px;}
  .time-custom-label{font-size:12px;color:var(--text-sub);white-space:nowrap;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="notif-banner" id="notifBanner">
  <span>â°</span>
  <div><div id="notifBannerText"></div><div style="font-size:11px;opacity:.7" id="notifBannerSub"></div></div>
</div>
<div class="theme-panel" id="themePanel">
  <div class="theme-option active" onclick="setTheme('default',this)"><div class="theme-dot" style="background:#111"></div></div>
  <div class="theme-option" onclick="setTheme('mono',this)"><div class="theme-dot" style="background:#b8c400"></div></div>
  <div class="theme-option" onclick="setTheme('natural',this)"><div class="theme-dot" style="background:#e05040"></div></div>
</div>
<div class="app">
  <div class="header">
    <div class="header-top">
      <div class="title-area">
        <div class="app-title">ã‚ã¨ã§<span class="title-dot"></span></div>
        <span class="task-count" id="taskCountBadge">0</span>
      </div>
      <div class="header-actions">
        <button class="theme-btn" onclick="toggleThemePanel()">â—</button>
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()">â†• <span id="sortLabel">æ—¥ä»˜é †</span></button>
        <button class="add-btn" onclick="openAddModal()">+</button>
      </div>
    </div>
  </div>
  <div class="habit-section">
    <div class="habit-header">
      <button class="habit-month-btn" onclick="openGraph()">Month</button>
      <button class="habit-manage-btn" onclick="openManageSheet()">ç·¨é›† Â·Â·Â·</button>
    </div>
    <div id="habitTable"></div>
  </div>
  <div class="tabs">
      <button class="tab active" id="tab-all" onclick="switchTab('all',this)">ã™ã¹ã¦</button>
      <button class="tab" id="tab-todo" onclick="switchTab('todo',this)">æœªå®Œäº†</button>
      <button class="tab" id="tab-done" onclick="switchTab('done',this)">å®Œäº†æ¸ˆã¿</button>
      <button class="tab" id="tab-urgent" onclick="switchTab('urgent',this)">ï¼ å¿…é ˆ</button>
    </div>
  <div class="list" id="taskList"></div>
</div>
<div class="bottom-bar">
  <button class="bottom-add-btn" onclick="openAddModal()"><span style="font-size:18px;font-weight:300">+</span> ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
</div>
<!-- Task Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header"><h3 id="modalTitle">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>
    <div class="form-group"><div class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</div><input class="form-input" id="inputTitle" type="text" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›"></div>
    <div class="form-group"><div class="form-label">ãƒ¡ãƒ¢</div><textarea class="form-textarea" id="inputMemo" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea></div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">æ—¥ä»˜</div><input class="form-input" id="inputDate" type="date"></div>
      <div class="form-group">
        <div class="form-label">æ™‚é–“</div>
        <div class="time-quick" id="timeQuick">
          <div class="time-chip-btn" onclick="selectTime(this,'07:00')">7:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'08:00')">8:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'09:00')">9:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'12:00')">12:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'18:00')">18:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'21:00')">21:00</div>
          <div class="time-chip-btn" onclick="selectTime(this,'')">ãªã—</div>
        </div>
        <div class="time-custom-wrap">
          <span class="time-custom-label">ã‚«ã‚¹ã‚¿ãƒ ï¼š</span>
          <input class="form-input" id="inputTime" type="time" style="flex:1" oninput="onTimeInput(this.value)">
        </div>
      </div>
    </div>
    <div class="form-group">
      <div class="form-label">é€šçŸ¥</div>
      <div class="notif-row" id="notifToggleRow" onclick="toggleNotif()"><span class="notif-row-label" id="notifLabel">é€šçŸ¥ã‚ªãƒ•</span><div class="tsw"></div></div>
      <div class="notif-hint" id="notifHint">â€» æ™‚é–“ã‚’å…¥åŠ›ã™ã‚‹ã¨è¨­å®šã§ãã¾ã™</div>
    </div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">å¯¾å¿œãƒã‚¹ãƒˆ</div><div class="urgent-toggle" id="urgentToggle" onclick="toggleUrgent()"><span class="utl" id="urgentLabel">ã‚ªãƒ•</span><div class="tsw"></div></div></div>
      <div class="form-group" style="visibility:hidden"></div>
    </div>
    <div class="form-group">
      <div class="form-label">ç¹°ã‚Šè¿”ã—</div>
      <div class="repeat-row">
        <div class="repeat-btn" onclick="selectRepeat(this,'none')">ãªã—</div>
        <div class="repeat-btn" onclick="selectRepeat(this,'daily')">æ¯æ—¥</div>
        <div class="repeat-btn" onclick="selectRepeat(this,'weekly')">æ¯é€±</div>
        <div class="repeat-btn" onclick="selectRepeat(this,'monthly')">æ¯æœˆ</div>
      </div>
      <div class="repeat-info" id="repeatInfo"></div>
      <div class="habit-link-row" id="habitLinkRow">
        <div class="habit-link-label">ç¿’æ…£ã«ã‚‚è¿½åŠ ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’é€£å‹•ã™ã‚‹</div>
        <div class="habit-link-opts" id="habitLinkOpts"></div>
      </div>
    </div>
    <div class="form-group">
      <div class="form-label">ã‚¿ã‚°</div>
      <div class="tag-selector" id="tagSelector">
        <div class="tag-option" onclick="selectTag(this,'ä»•äº‹')">ä»•äº‹</div>
        <div class="tag-option" onclick="selectTag(this,'å¥åº·')">å¥åº·</div>
        <div class="tag-option" onclick="selectTag(this,'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ')">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</div>
        <div class="tag-option" onclick="selectTag(this,'è²·ã„ç‰©')">è²·ã„ç‰©</div>
        <div class="tag-option" onclick="selectTag(this,'å‹‰å¼·')">å‹‰å¼·</div>
        <div class="tag-option add-tag" onclick="showCustomTag()">ï¼‹</div>
      </div>
      <input class="form-input tag-custom-input" id="customTagInput" type="text" placeholder="ã‚¿ã‚°å">
    </div>
    <button class="btn-submit" id="submitBtn" onclick="submitModal()">è¿½åŠ ã™ã‚‹</button>
    <button class="btn-del-task" id="deleteInModalBtn" onclick="deleteFromModal()" style="display:none">ğŸ—‘ å‰Šé™¤</button>
  </div>
</div>
<!-- Confirm -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box"><div class="ci">ğŸ—‘</div><div class="ct">å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div><div class="cs" id="confirmSub"></div><div class="cb-btns"><button class="cc" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="cd" onclick="confirmDelete()">å‰Šé™¤</button></div></div>
</div>
<!-- Manage Sheet -->
<div class="sheet-overlay" id="manageSheetOverlay" onclick="if(event.target===this)closeManageSheet()">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sheet-header"><span class="sheet-title">ç¿’æ…£ã®ç·¨é›†</span><button class="sheet-close" onclick="closeManageSheet()">âœ•</button></div>
    <div id="habitItemList"></div>
    <div class="add-hr">
      <button class="form-input add-em-btn" id="emojiPickerBtn" style="display:none">ğŸ˜Š</button>
      <input class="form-input add-nm-inp" id="newHabitName" placeholder="ç¿’æ…£åï¼ˆä¾‹: é‹å‹•ï¼‰" type="text" onkeydown="if(event.key==='Enter')addHabitItem()">
      <button class="add-btn-s" onclick="addHabitItem()">è¿½åŠ </button>
    </div>
  </div>
</div>
<!-- Emoji Picker -->
<div class="emo-overlay" id="emojiOverlay" onclick="if(event.target===this)closeEmojiPicker()">
  <div class="emo-box"><div style="font-size:12px;color:var(--text-sub);margin-bottom:10px;font-weight:600">çµµæ–‡å­—ã‚’é¸æŠ</div><div class="emo-grid" id="emojiGrid"></div></div>
</div>
<!-- Graph Sheet -->
<div class="graph-overlay" id="graphOverlay" onclick="if(event.target===this)closeGraph()">
  <div class="graph-sheet">
    <div class="sh"></div>
    <div class="g-nav"><button class="g-nb" onclick="changeGraphMonth(-1)">â€¹</button><span class="g-ml" id="graphMonthLbl"></span><button class="g-nb" onclick="changeGraphMonth(1)">â€º</button></div>
    <div class="g-htabs" id="graphHabitTabs"></div>
    <div class="g-summary" id="graphSummary"></div>
    <div class="g-cal" id="graphCal"></div>
    <div class="g-bt">é€±ã”ã¨ã®é”æˆ</div>
    <div id="graphBars"></div>
  </div>
</div>
<script>
// â”€â”€ Supabase â”€â”€
var SUPABASE_URL='https://rlbnancnmsxwamsecxhc.supabase.co';
var SUPABASE_KEY='sb_publishable_ZRNslRcLhzsUlaRRIO3HqA_n2zd5I7B';
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
var tasks=[];
var habitDefs=[];
var habitLogs={};
var nextHabitId=Date.now();
var sortByDate=localStorage.getItem('atode_sort')==='date',currentTab=localStorage.getItem('atode_tab')||'all',selectedTag='',urgentOn=false,notifOn=false,isCustomTag=false,repeatMode='none',linkedHabitId=null;
var notifTimers={},editingId=null,pendingDeleteId=null;
var graphMonth=new Date(),selGraphHabit=null;
var dragSrc=null;
// localStorage fallback (ãƒ†ãƒ¼ãƒã®ã¿)
function save(){/* Supabaseã«ç§»è¡Œæ¸ˆã¿ - äº’æ›ã®ãŸã‚æ®‹ã™ */}
function setTheme(n,el){document.documentElement.setAttribute('data-theme',n==='default'?'':n);document.querySelectorAll('.theme-option').forEach(function(o){o.classList.remove('active');});if(el)el.classList.add('active');localStorage.setItem('atode_theme',n);closeThemePanel();}
function toggleThemePanel(){document.getElementById('themePanel').classList.toggle('open');}
function closeThemePanel(){document.getElementById('themePanel').classList.remove('open');}
(function(){var t=localStorage.getItem('atode_theme');if(t&&t!=='default'){document.documentElement.setAttribute('data-theme',t);document.querySelectorAll('.theme-option').forEach(function(o){o.classList.toggle('active',o.getAttribute('onclick').indexOf("'"+t+"'")>-1);});}})();
function pad(n){return String(n).padStart(2,'0');}
function todayStr(){var d=new Date();return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
function dateStr(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
function renderHabitTable(){
  var wrap=document.getElementById('habitTable');
  if(!wrap)return;
  if(!habitDefs.length){wrap.innerHTML='<div style="font-size:12px;color:var(--text-sub);padding:6px 0 10px">ã€Œç·¨é›†ã€ã‹ã‚‰ç¿’æ…£ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';return;}
  var today=new Date();today.setHours(0,0,0,0);
  var dow=(today.getDay()+6)%7;
  var wkStart=new Date(today);wkStart.setDate(today.getDate()-dow);
  var DL=['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  var dates=[];
  for(var i=0;i<7;i++){var d=new Date(wkStart);d.setDate(wkStart.getDate()+i);dates.push(d);}
  var html='<table class="habit-table"><thead><tr><th class="habit-lbl-cell"></th>';
  dates.forEach(function(d,i){html+='<th>'+DL[i]+'</th>';});
  html+='</tr><tr class="habit-date-row"><td></td>';
  dates.forEach(function(d){var isT=dateStr(d)===todayStr();html+='<td class="'+(isT?'habit-date-today':'')+'">'+d.getDate()+'</td>';});
  html+='</tr></thead><tbody>';
  habitDefs.forEach(function(h){
    var logs=habitLogs[h.id]||{};
    html+='<tr><td class="habit-lbl-cell"><div class="habit-lbl-inner"><span class="habit-name-txt">'+h.name+'</span></div></td>';
    dates.forEach(function(d){
      var ds=dateStr(d);var isToday=ds===todayStr();var isFuture=d>today;var isChecked=!!logs[ds];
      var cls='h-dot';if(isToday)cls+=' today-dot';if(isChecked)cls+=' checked';if(isFuture)cls+=' future';
      var click=isFuture?'':'onclick="toggleHabit(\''+h.id+'\',\''+ds+'\')"';
      html+='<td class="habit-dot-cell"><div class="'+cls+'" '+click+'></div></td>';
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;
}
async function toggleHabit(hid,ds){
  hid=String(hid);
  if(!habitLogs[hid])habitLogs[hid]={};
  var wasChecked=!!habitLogs[hid][ds];
  // UIã‚’å³æ™‚æ›´æ–°
  if(wasChecked){delete habitLogs[hid][ds];}else{habitLogs[hid][ds]=true;}
  renderHabitTable();
  if(document.getElementById('graphOverlay').classList.contains('open'))renderGraph();
  // ãƒã‚§ãƒƒã‚¯ONæ™‚ã«è¤’ã‚ãƒãƒ–ãƒ«
  if(!wasChecked){
    try{
      var dotEl=event&&event.target;
      if(dotEl){
        var rect=dotEl.getBoundingClientRect();
        var b=document.createElement('div');b.className='habit-praise';
        b.textContent=praises[Math.floor(Math.random()*praises.length)];
        b.style.left=(rect.left+rect.width/2-40)+'px';
        b.style.top=(rect.top+window.scrollY-44)+'px';
        document.body.appendChild(b);setTimeout(function(){b.remove();},1700);
      }
    }catch(e){}
  }
  // Supabaseã«ä¿å­˜ï¼ˆå¤±æ•—ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  var res;
  if(wasChecked){
    res=await sb.from('habit_logs').delete().eq('item_id',hid).eq('log_date',ds);
  }else{
    res=await sb.from('habit_logs').insert([{item_id:hid,log_date:ds}]);
  }
  if(res.error){
    // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if(wasChecked){habitLogs[hid][ds]=true;}else{delete habitLogs[hid][ds];}
    renderHabitTable();
    console.error('toggleHabit error:',res.error);
  }
}
function openManageSheet(){renderHabitItemList();document.getElementById('manageSheetOverlay').classList.add('open');}
function closeManageSheet(){document.getElementById('manageSheetOverlay').classList.remove('open');}
function renderHabitItemList(){
  document.getElementById('habitItemList').innerHTML=habitDefs.map(function(h,i){
    return '<div class="hi-row" draggable="true" data-idx="'+i+'" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="dragDrop(event)">'+
      '<span class="hi-dh">â ¿</span>'+
      '<input class="hi-name-input" value="'+h.name.replace(/"/g,'&quot;')+'" onblur="renameHabitItem(\''+h.id+'\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()">'+
      '<button class="hi-del" onclick="removeHabitItem(\''+h.id+'\')">âœ•</button></div>';
  }).join('');
}
async function renameHabitItem(id,newName){
  newName=(newName||'').trim();
  if(!newName)return;
  var h=habitDefs.find(function(x){return String(x.id)===String(id);});
  if(!h||h.name===newName)return;
  h.name=newName;
  renderHabitTable();
  await sb.from('habit_items').update({name:newName}).eq('id',id);
}
async function addHabitItem(){
  var name=document.getElementById('newHabitName').value.trim();
  var emoji='';
  if(!name){document.getElementById('newHabitName').focus();return;}
  var sortOrder=habitDefs.length;
  var res=await sb.from('habit_items').insert([{emoji:emoji,name:name,sort_order:sortOrder}]).select().single();
  if(res.error){console.error(res.error);return;}
  var h=res.data;
  habitDefs.push({id:String(h.id),emoji:h.emoji||'',name:h.name});
  habitLogs[h.id]={};
  renderHabitItemList();renderHabitTable();
  document.getElementById('newHabitName').value='';document.getElementById('emojiPickerBtn').textContent='ğŸ˜Š';
}
async function removeHabitItem(id){
  await sb.from('habit_items').delete().eq('id',id);
  await sb.from('habit_logs').delete().eq('item_id',id);
  habitDefs=habitDefs.filter(function(h){return h.id!==id;});
  delete habitLogs[id];
  renderHabitItemList();renderHabitTable();
}
async function moveHabitItem(idx,dir){
  var ni=idx+dir;
  if(ni<0||ni>=habitDefs.length)return;
  var tmp=habitDefs[idx];habitDefs[idx]=habitDefs[ni];habitDefs[ni]=tmp;
  renderHabitItemList();renderHabitTable();
  for(var i=0;i<habitDefs.length;i++){
    await sb.from('habit_items').update({sort_order:i}).eq('id',habitDefs[i].id);
  }
}
var EMOJIS=['ğŸ˜Š','ğŸ’ª','ğŸƒ','ğŸ“–','ğŸ’§','ğŸ¥—','ğŸ§˜','ğŸ˜´','â˜€ï¸','ğŸµ','âœï¸','ğŸ§ ','ğŸŒ±','â¤ï¸','ğŸ”¥','â­','ğŸ¯','ğŸ’Š','ğŸš¶','ğŸ','â˜•','ğŸ§¹','ğŸ’°','ğŸ¨','ğŸ¤¸','ğŸ‹ï¸','ğŸ§´','ğŸ“','ğŸ™','ğŸŒ¸','ğŸ¦·','ğŸ›','ğŸ¥¤','ğŸµ','ğŸ®','ğŸ“±','ğŸ’»','ğŸš´','ğŸŠ','ğŸ§—'];
function openEmojiPicker(){document.getElementById('emojiGrid').innerHTML=EMOJIS.map(function(e){return '<div class="emo-cell" onclick="selectEmoji(\''+e+'\')">'+e+'</div>';}).join('');document.getElementById('emojiOverlay').classList.add('open');}
function closeEmojiPicker(){document.getElementById('emojiOverlay').classList.remove('open');}
function selectEmoji(em){document.getElementById('emojiPickerBtn').textContent=em;closeEmojiPicker();}
function openGraph(){graphMonth=new Date();selGraphHabit=habitDefs[0]?habitDefs[0].id:null;renderGraphTabs();renderGraph();document.getElementById('graphOverlay').classList.add('open');}
function closeGraph(){document.getElementById('graphOverlay').classList.remove('open');}
function changeGraphMonth(d){graphMonth=new Date(graphMonth.getFullYear(),graphMonth.getMonth()+d,1);renderGraph();}
function renderGraphTabs(){document.getElementById('graphHabitTabs').innerHTML=habitDefs.map(function(h){return '<div class="g-ht '+(h.id===selGraphHabit?'active':'')+'" onclick="selGH(\''+h.id+'\')">'+h.name+'</div>';}).join('');}
function selGH(id){selGraphHabit=id;renderGraphTabs();renderGraph();}
function toggleGraphHabit(hid,ds){toggleHabit(hid,ds);renderGraph();}
function renderGraph(){
  if(!selGraphHabit&&habitDefs.length)selGraphHabit=habitDefs[0].id;
  var logs=habitLogs[selGraphHabit]||{};
  var y=graphMonth.getFullYear(),m=graphMonth.getMonth();
  var MN=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  document.getElementById('graphMonthLbl').textContent=y+'å¹´ '+MN[m];
  var today=new Date();today.setHours(0,0,0,0);
  var dim=new Date(y,m+1,0).getDate();
  /* offset moved to offsetSun below */
  var checked=0,streak=0,cur=0;
  for(var d=1;d<=dim;d++){var ds=y+'-'+pad(m+1)+'-'+pad(d);var cd=new Date(y,m,d);cd.setHours(0,0,0,0);if(cd>today)break;if(logs[ds]){checked++;cur++;}else cur=0;}
  if(m===today.getMonth()&&y===today.getFullYear()){for(var d2=today.getDate();d2>=1;d2--){if(logs[y+'-'+pad(m+1)+'-'+pad(d2)])streak++;else break;}}
  var total=(m===today.getMonth()&&y===today.getFullYear())?today.getDate():dim;
  var rate=total?Math.round(checked/total*100):0;
  var el=document.getElementById('graphSummary');if(el)el.innerHTML='<span class="g-sum-label">'+MN[m]+'ã®é”æˆ</span><span class="g-sum-val">'+checked+' / '+total+' æ—¥</span>';
  // æ—¥æ›œå§‹ã¾ã‚Š
  var firstDowSun=new Date(y,m,1).getDay(); // Sun=0
  var offsetSun=firstDowSun;
  var hdrs=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(function(d){return '<div class="g-ch">'+d+'</div>';}).join('');
  var cells=hdrs;
  for(var i=0;i<offsetSun;i++)cells+='<div class="g-cc ec"></div>';
  for(var d3=1;d3<=dim;d3++){
    var ds3=y+'-'+pad(m+1)+'-'+pad(d3);
    var cd3=new Date(y,m,d3);cd3.setHours(0,0,0,0);
    var isFuture=cd3>today,isToday=cd3.getTime()===today.getTime();
    var cls='g-cc';
    if(isFuture)cls+=' fut';
    else if(logs[ds3])cls+=' ck';
    else if(isToday)cls+=' tc';
    var click=isFuture?'':'onclick="toggleGraphHabit(\''+selGraphHabit+'\',\''+ds3+'\')"';
    cells+='<div class="'+cls+'" '+click+'><span>'+d3+'</span></div>';
  }
  document.getElementById('graphCal').innerHTML=cells;
  var weeks=[];
  for(var d4=1;d4<=dim;d4++){var ds4=y+'-'+pad(m+1)+'-'+pad(d4);var cd4=new Date(y,m,d4);cd4.setHours(0,0,0,0);var wk=Math.floor((d4+offsetSun-1)/7);if(!weeks[wk])weeks[wk]={count:0,total:0};if(cd4<=today){weeks[wk].total++;if(logs[ds4])weeks[wk].count++;}}
  document.getElementById('graphBars').innerHTML=weeks.map(function(w,i){return w&&w.total?'<div class="g-br"><div class="g-bl">W'+(i+1)+'</div><div class="g-btr"><div class="g-bf" style="width:'+Math.round(w.count/w.total*100)+'%"></div></div><div class="g-bc">'+w.count+'/'+w.total+'</div></div>':'';}).join('');
}
var praises=['ã™ã”ã„ï¼âœ¨','å¤©æ‰ï¼ğŸŒŸ','ã•ã™ãŒï¼ğŸ‰','ã‚„ã£ãŸã­ï¼ğŸ¥³','å®Œç’§ï¼ğŸ’¯','ãˆã‚‰ã„ï¼ğŸ‘','æœ€é«˜ï¼ğŸ”¥','ç´ æ™´ã‚‰ã—ã„ï¼ğŸŒ¸','ã§ããŸï¼ğŸŠ','ãƒŠã‚¤ã‚¹ï¼ğŸ™Œ','ã‚„ã‚‹ã˜ã‚ƒã‚“ï¼ğŸ‘'];
function fmtDate(s){if(!s)return null;var d=new Date(s+'T00:00');return (d.getMonth()+1)+'/'+d.getDate();}
function fmtHead(s){if(!s)return 'æ—¥ä»˜ãªã—';var d=new Date(s+'T00:00');var D=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];return (d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ï¼ˆ'+D[d.getDay()]+'ï¼‰';}
function toggleSort(){sortByDate=!sortByDate;localStorage.setItem('atode_sort',sortByDate?'date':'');document.getElementById('sortLabel').textContent=sortByDate?'ä½œæˆé †':'æ—¥ä»˜é †';document.getElementById('sortBtn').classList.toggle('active',sortByDate);render();}
function switchTab(tab,el){currentTab=tab;localStorage.setItem('atode_tab',tab);document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});el.classList.add('active');render();}
function getFiltered(){
  var t=tasks.slice();
  if(currentTab==='todo')t=t.filter(function(x){return!x.done;});
  else if(currentTab==='done')t=t.filter(function(x){return x.done;});
  else if(currentTab==='urgent')t=t.filter(function(x){return x.urgent&&!x.done;});
  if(sortByDate)t.sort(function(a,b){var da=a.date||'9999',db=b.date||'9999';return da<db?-1:da>db?1:a.createdAt-b.createdAt;});
  else t.sort(function(a,b){return a.createdAt-b.createdAt;});
  return t;
}
function groupTasks(ts){
  var g={};
  ts.forEach(function(t){
    var k;if(sortByDate){k=t.date||'__nodate__';}else{var d=new Date(t.createdAt);k=d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
    if(!g[k])g[k]=[];g[k].push(t);
  });
  return g;
}
function render(){
  var list=document.getElementById('taskList');
  var filtered=getFiltered();
  document.getElementById('taskCountBadge').textContent=tasks.filter(function(t){return!t.done;}).length;
  if(!filtered.length){list.innerHTML='<div class="empty"><div class="empty-icon">âœ“</div>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  var groups=groupTasks(filtered);
  var html='';
  Object.keys(groups).forEach(function(key){
    html+='<div class="date-heading">'+(sortByDate?(key==='__nodate__'?'æ—¥ä»˜ãªã—':fmtHead(key)):fmtHead(key))+'</div>';
    groups[key].forEach(function(task){
      var dd=fmtDate(task.date);
      var tagH=task.tag?'<div class="task-tags"><span class="tag">'+task.tag+'</span></div>':'';
      var memoH=task.memo?'<div class="task-memo">'+task.memo+'</div>':'';
      var uM=task.urgent?'<div class="urgent-mark">ï¼</div>':'';
      var metaH='';
      if(task.time&&!task.done)metaH='<div class="task-meta"><span class="time-chip">ğŸ• '+task.time+'</span><span class="notif-icon '+(task.notif?'on':'')+'" onclick="toggleTaskNotif('+task.id+',event)">'+(task.notif?'ğŸ””':'ğŸ”•')+'</span></div>';
      else if(task.time&&task.done)metaH='<div class="task-meta"><span class="time-chip">ğŸ• '+task.time+'</span></div>';
      var repeatLabel={daily:'æ¯æ—¥',weekly:'æ¯é€±',monthly:'æ¯æœˆ'};var rbadge=task.repeat&&task.repeat!=='none'?'<span class="repeat-badge">'+repeatLabel[task.repeat]+'</span>':'';
      html+='\n<div class="task-card'+(task.urgent?' urgent':'')+(task.done?' done':'')+'" id="card-'+task.id+'" onclick="openEditModal('+task.id+')">'+
        '<div class="cb-wrap"><div class="cb'+(task.done?' checked':'')+'" id="cb-'+task.id+'" onclick="toggleTask('+task.id+',event)">'+
        '<svg width="11" height="9" viewBox="0 0 12 10" fill="none"><path d="M1 5L4.5 8.5L11 1" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>'+
        '<div class="sp-container" id="sp-'+task.id+'"></div></div>'+
        uM+'<div class="task-content"><div class="task-header"><div class="task-title">'+task.title+'</div>'+(dd?'<div class="task-date">'+dd+'</div>':'')+'</div>'+metaH+memoH+tagH+'</div>'+
        '<button class="card-del-btn" onclick="askDelete('+task.id+',event)">ğŸ—‘</button></div>';
    });
  });
  list.innerHTML=html;
}
async function toggleTask(id,e){
  e.stopPropagation();
  var task=tasks.find(function(t){return t.id===id;});if(!task)return;
  var newDone=!task.done;
  // UIã‚’å³æ™‚æ›´æ–°ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
  var card=document.getElementById('card-'+id),cb=document.getElementById('cb-'+id);
  if(newDone){
    task.done=true;
    spawnSparkles(document.getElementById('sp-'+id));
    var cbWrap=document.getElementById('cb-'+id);
    if(cbWrap&&cbWrap.parentElement){var b=document.createElement('div');b.className='praise';b.textContent=praises[Math.floor(Math.random()*praises.length)];cbWrap.parentElement.appendChild(b);setTimeout(function(){b.remove();},1700);}
    if(card){card.classList.add('done');card.classList.remove('urgent');}
    if(cb){cb.classList.add('checked');cb.querySelector('svg').style.display='block';}
    var te=card&&card.querySelector('.task-title');if(te)te.style.textDecoration='line-through';
    if(notifTimers[id]){clearTimeout(notifTimers[id]);delete notifTimers[id];}
    // é€£å‹•ãƒãƒ“ãƒƒãƒˆãŒã‚ã‚Œã°ãƒã‚§ãƒƒã‚¯
    if(task.linked_habit){
      var ds=todayStr();
      if(!habitLogs[task.linked_habit])habitLogs[task.linked_habit]={};
      if(!habitLogs[task.linked_habit][ds]){
        habitLogs[task.linked_habit][ds]=true;
        renderHabitTable();
        sb.from('habit_logs').insert([{item_id:parseInt(task.linked_habit),log_date:ds}]);
      }
    }
    setTimeout(function(){render();},1200);
  }else{
    task.done=false;
    if(card){card.classList.remove('done');}
    if(cb){cb.classList.remove('checked');}
    render();scheduleNotif(task);
  }
  // Supabaseã«ä¿å­˜ï¼ˆå¤±æ•—ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  var res=await sb.from('tasks').update({done:newDone}).eq('id',id);
  if(res.error){
    task.done=!newDone; // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    render();
    console.error('toggleTask error:',res.error);
  }
}
async function toggleTaskNotif(id,e){
  e.stopPropagation();
  var task=tasks.find(function(t){return t.id===id;});if(!task)return;
  task.notif=!task.notif;
  if(task.notif)requestNotifPermission(function(){scheduleNotif(task);});
  else if(notifTimers[id]){clearTimeout(notifTimers[id]);delete notifTimers[id];}
  var res2=await sb.from('tasks').update({notif:task.notif}).eq('id',id);
  if(res2.error){task.notif=!task.notif;}
  render();
}
function askDelete(id,e){if(e)e.stopPropagation();var task=tasks.find(function(t){return t.id===id;});if(!task)return;pendingDeleteId=id;document.getElementById('confirmSub').textContent='ã€Œ'+task.title+'ã€ã‚’å‰Šé™¤ã—ã¾ã™';document.getElementById('confirmOverlay').classList.add('open');}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('open');pendingDeleteId=null;}
async function confirmDelete(){if(!pendingDeleteId)return;var did=pendingDeleteId;tasks=tasks.filter(function(t){return t.id!==did;});if(notifTimers[did]){clearTimeout(notifTimers[did]);delete notifTimers[did];}closeConfirm();closeModal();render();await sb.from('tasks').delete().eq('id',did);}
function deleteFromModal(){if(editingId)askDelete(editingId,null);}
function spawnSparkles(container){
  if(!container)return;
  var P=['#e8673a','#f5a07a','#111','#444','#f5c842','#7ae8d4','#fff'];
  var S=['','','star'];container.innerHTML='';
  for(var i=0;i<16;i++){
    var s=document.createElement('div');var sh=S[Math.floor(Math.random()*S.length)];
    s.className='sp'+(sh?' '+sh:'');
    var a=(i/16)*360+(Math.random()*20-10),dist=14+Math.random()*20;
    s.style.setProperty('--tx',Math.cos(a*Math.PI/180)*dist+'px');
    s.style.setProperty('--ty',Math.sin(a*Math.PI/180)*dist+'px');
    s.style.setProperty('--rot',(Math.random()*720-360)+'deg');
    s.style.background=P[Math.floor(Math.random()*P.length)];
    var sz=3+Math.random()*4;s.style.width=sz+'px';s.style.height=sz+'px';s.style.left=(-sz/2)+'px';s.style.top=(-sz/2)+'px';
    container.appendChild(s);
    (function(el,delay){setTimeout(function(){el.classList.add('active');},delay);})(s,i*16+Math.random()*25);
  }
}
function requestNotifPermission(cb){if(!('Notification'in window)){if(cb)cb();return;}if(Notification.permission==='granted'){if(cb)cb();return;}Notification.requestPermission().then(function(p){if(p==='granted'&&cb)cb();});}
function scheduleNotif(task){if(!task.date||!task.time||!task.notif||task.done)return;var diff=new Date(task.date+'T'+task.time+':00')-new Date();if(diff<=0)return;if(notifTimers[task.id])clearTimeout(notifTimers[task.id]);notifTimers[task.id]=setTimeout(function(){fireNotif(task);},diff);}
function fireNotif(task){showBanner('â° '+task.title,task.time+' ã®äºˆå®šæ™‚åˆ»ã§ã™');if('Notification'in window&&Notification.permission==='granted')new Notification('ã‚ã¨ã§ â°',{body:task.title+'\n'+task.time+' ã®äºˆå®šæ™‚åˆ»ã§ã™'});}
function showBanner(text,sub){var b=document.getElementById('notifBanner');document.getElementById('notifBannerText').textContent=text;document.getElementById('notifBannerSub').textContent=sub;b.classList.add('show');setTimeout(function(){b.classList.remove('show');},4500);}
function scheduleAll(){requestNotifPermission(function(){tasks.forEach(function(t){scheduleNotif(t);});});}
function resetForm(){
  ['inputTitle','inputMemo','inputDate','inputTime','customTagInput'].forEach(function(id){var el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('inputMemo').style.height='64px';
  repeatMode='none';
  document.querySelectorAll('.repeat-btn').forEach(function(b){b.classList.remove('selected');});
  document.querySelector('.repeat-btn').classList.add('selected'); // ã€Œãªã—ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
  document.getElementById('repeatInfo').textContent='';
  linkedHabitId=null;
  document.getElementById('habitLinkRow').classList.remove('visible');;
  document.getElementById('customTagInput').classList.remove('visible');
  document.querySelectorAll('.tag-option').forEach(function(t){t.classList.remove('selected');});
  selectedTag='';isCustomTag=false;urgentOn=false;notifOn=false;
  document.getElementById('urgentToggle').classList.remove('on');
  document.getElementById('urgentLabel').textContent='ã‚ªãƒ•';
  document.getElementById('notifToggleRow').classList.remove('on');
  document.getElementById('notifLabel').textContent='é€šçŸ¥ã‚ªãƒ•';
  document.getElementById('notifHint').classList.add('visible');
}
function openAddModal(){
  editingId=null;resetForm();
  document.getElementById('modalTitle').textContent='æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
  document.getElementById('submitBtn').textContent='è¿½åŠ ã™ã‚‹';
  document.getElementById('deleteInModalBtn').style.display='none';
  document.getElementById('inputDate').value=new Date().toISOString().split('T')[0];
  document.querySelectorAll('.time-chip-btn').forEach(function(b){b.classList.remove('selected');});document.querySelector('.time-chip-btn[onclick*="\'\'"]')&&document.querySelector('.time-chip-btn[onclick*="\'\'"]').classList.add('selected');
  document.getElementById('modalOverlay').classList.add('open');
  setTimeout(function(){document.getElementById('inputTitle').focus();},120);
}
function openEditModal(id){
  var task=tasks.find(function(t){return t.id===id;});if(!task)return;
  editingId=id;resetForm();
  document.getElementById('modalTitle').textContent='ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
  document.getElementById('submitBtn').textContent='ä¿å­˜ã™ã‚‹';
  document.getElementById('deleteInModalBtn').style.display='block';
  document.getElementById('inputTitle').value=task.title;
  document.getElementById('inputMemo').value=task.memo||'';
  setTimeout(autoResizeMemo,0);
  document.getElementById('inputDate').value=task.date||'';
  document.getElementById('inputTime').value=task.time||'';
  // æ™‚é–“ãƒœã‚¿ãƒ³é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
  document.querySelectorAll('.time-chip-btn').forEach(function(b){var m=b.getAttribute('onclick').match(/\'([^\']*)\'/);
    b.classList.toggle('selected',m&&m[1]===(task.time||''));});
  var tagEls=Array.from(document.querySelectorAll('.tag-option:not(.add-tag)'));
  var matched=tagEls.find(function(el){return el.textContent===task.tag;});
  if(matched){matched.classList.add('selected');selectedTag=task.tag;}
  else if(task.tag){isCustomTag=true;selectedTag=task.tag;var ci=document.getElementById('customTagInput');ci.value=task.tag;ci.classList.add('visible');}
  urgentOn=task.urgent;if(urgentOn){document.getElementById('urgentToggle').classList.add('on');document.getElementById('urgentLabel').textContent='ï¼å¯¾å¿œãƒã‚¹ãƒˆ';}
  notifOn=task.notif&&!!task.time;if(notifOn){document.getElementById('notifToggleRow').classList.add('on');document.getElementById('notifLabel').textContent='ğŸ”” é€šçŸ¥ã‚ªãƒ³';}
  // ç¹°ã‚Šè¿”ã—å¾©å…ƒ
  repeatMode=task.repeat||'none';
  document.querySelectorAll('.repeat-btn').forEach(function(b){b.classList.toggle('selected',b.textContent==={none:'ãªã—',daily:'æ¯æ—¥',weekly:'æ¯é€±',monthly:'æ¯æœˆ'}[repeatMode]);});
  var info={none:'',daily:'æœªå®Œäº†ã®ã¾ã¾ç¿Œæ—¥ã«ãªã‚‹ã¨ã€æ—¥ä»˜ãŒè‡ªå‹•ã§æ¬¡ã®æ—¥ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚',weekly:'æ¯é€±åŒã˜æ›œæ—¥ã«æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚',monthly:'æ¯æœˆåŒã˜æ—¥ã«æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚'};
  document.getElementById('repeatInfo').textContent=info[repeatMode]||'';
  linkedHabitId=task.linked_habit||null;
  if(repeatMode==='daily'){
    var row=document.getElementById('habitLinkRow');row.classList.add('visible');
    var opts=document.getElementById('habitLinkOpts');
    opts.innerHTML='<div class="habit-link-btn'+(linkedHabitId===null?' selected':'')+'" onclick="selectHabitLink(null,this)">ãªã—</div>'+
      habitDefs.map(function(h){return '<div class="habit-link-btn'+(linkedHabitId===String(h.id)?' selected':'')+'" onclick="selectHabitLink(\''+h.id+'\',this)">'+h.name+'</div>';}).join('');
  }
  document.getElementById('notifHint').classList.toggle('visible',!task.time);
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');editingId=null;}
function handleOverlayClick(e){if(e.target===e.currentTarget)closeModal();}
function selectTime(el,val){
  document.getElementById('inputTime').value=val;
  document.querySelectorAll('.time-chip-btn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected');
  onTimeInput(val);
}
function onTimeInput(val){
  // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ™‚ã¯ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.time-chip-btn').forEach(function(b){
    b.classList.toggle('selected', b.dataset&&b.getAttribute('onclick')&&b.getAttribute('onclick').indexOf("'"+val+"'")>-1);
  });
  document.getElementById('notifHint').classList.toggle('visible',!val);
  if(!val){notifOn=false;document.getElementById('notifToggleRow').classList.remove('on');document.getElementById('notifLabel').textContent='é€šçŸ¥ã‚ªãƒ•';}
}
function toggleUrgent(){urgentOn=!urgentOn;document.getElementById('urgentToggle').classList.toggle('on',urgentOn);document.getElementById('urgentLabel').textContent=urgentOn?'ï¼å¯¾å¿œãƒã‚¹ãƒˆ':'ã‚ªãƒ•';}
function toggleNotif(){if(!document.getElementById('inputTime').value){document.getElementById('notifHint').classList.add('visible');return;}notifOn=!notifOn;document.getElementById('notifToggleRow').classList.toggle('on',notifOn);document.getElementById('notifLabel').textContent=notifOn?'ğŸ”” é€šçŸ¥ã‚ªãƒ³':'é€šçŸ¥ã‚ªãƒ•';if(notifOn)requestNotifPermission(null);}
document.getElementById('inputTime').addEventListener('input',function(){onTimeInput(this.value);});
function autoResizeMemo(){var el=document.getElementById('inputMemo');el.style.height='64px';el.style.height=Math.max(64,el.scrollHeight)+'px';}
document.getElementById('inputMemo').addEventListener('input',autoResizeMemo);
function selectRepeat(el,mode){
  repeatMode=mode;
  document.querySelectorAll('.repeat-btn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected');
  var info={none:'',daily:'æœªå®Œäº†ã®ã¾ã¾ç¿Œæ—¥ã«ãªã‚‹ã¨ã€æ—¥ä»˜ãŒè‡ªå‹•ã§æ¬¡ã®æ—¥ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚',weekly:'æ¯é€±åŒã˜æ›œæ—¥ã«æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚',monthly:'æ¯æœˆåŒã˜æ—¥ã«æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚'};
  document.getElementById('repeatInfo').textContent=info[mode]||'';
  // æ¯æ—¥ã®ã¨ãç¿’æ…£ãƒªãƒ³ã‚¯æ¬„ã‚’è¡¨ç¤º
  var row=document.getElementById('habitLinkRow');
  if(mode==='daily'){
    row.classList.add('visible');
    var opts=document.getElementById('habitLinkOpts');
    opts.innerHTML='<div class="habit-link-btn'+(linkedHabitId===null?' selected':'')+'" onclick="selectHabitLink(null,this)">ãªã—</div>'+
      habitDefs.map(function(h){return '<div class="habit-link-btn'+(linkedHabitId===h.id?' selected':'')+'" onclick="selectHabitLink(\''+h.id+'\',this)">'+h.name+'</div>';}).join('');
  }else{
    row.classList.remove('visible');
    linkedHabitId=null;
  }
}
function selectHabitLink(id,el){
  linkedHabitId=id;
  document.querySelectorAll('.habit-link-btn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected');
}
function selectTag(el,name){var already=el.classList.contains('selected');document.querySelectorAll('.tag-option:not(.add-tag)').forEach(function(t){t.classList.remove('selected');});if(!already){el.classList.add('selected');selectedTag=name;}else selectedTag='';document.getElementById('customTagInput').classList.remove('visible');isCustomTag=false;}
function showCustomTag(){document.querySelectorAll('.tag-option:not(.add-tag)').forEach(function(t){t.classList.remove('selected');});selectedTag='';isCustomTag=true;var i=document.getElementById('customTagInput');i.classList.add('visible');i.focus();}
async function submitModal(){
  var title=document.getElementById('inputTitle').value.trim();
  if(!title){var inp=document.getElementById('inputTitle');inp.style.borderColor='var(--accent)';inp.focus();setTimeout(function(){inp.style.borderColor='';},1400);return;}
  var memo=document.getElementById('inputMemo').value.trim();
  var date=document.getElementById('inputDate').value;
  var time=document.getElementById('inputTime').value;
  var tag=isCustomTag?document.getElementById('customTagInput').value.trim():selectedTag;
  var repeat=repeatMode||'none';
  var linked_habit=repeat==='daily'?linkedHabitId:null;
  var notif=notifOn&&!!time;
  var currentEditId=editingId;
  closeModal();showSync(true);
  if(currentEditId){
    var res=await sb.from('tasks').update({title:title,memo:memo,date:date,time:time,notif:notif,tag:tag,urgent:urgentOn,repeat:repeat,linked_habit:linked_habit}).eq('id',currentEditId).select().single();
    showSync(false);
    if(!res.error){var task=tasks.find(function(t){return t.id===currentEditId;});if(task){Object.assign(task,{title:title,memo:memo,date:date,time:time,notif:notif,tag:tag,urgent:urgentOn,repeat:repeat,linked_habit:linked_habit});scheduleNotif(task);}}
  }else{
    var res=await sb.from('tasks').insert([{title:title,memo:memo,date:date,time:time,notif:notif,tag:tag,urgent:urgentOn,done:false,repeat:repeat,linked_habit:linked_habit}]).select().single();
    showSync(false);
    if(!res.error){var nt={id:res.data.id,title:title,memo:memo,date:date,time:time,notif:notif,tag:tag,urgent:urgentOn,done:false,repeat:repeat,linked_habit:linked_habit,createdAt:new Date(res.data.created_at)};tasks.push(nt);if(notif)requestNotifPermission(function(){scheduleNotif(nt);});}
  }
  render();
}
document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeModal();closeConfirm();closeThemePanel();closeManageSheet();closeGraph();closeEmojiPicker();}if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openAddModal();}});
document.addEventListener('click',function(e){var p=document.getElementById('themePanel');if(p.classList.contains('open')&&!p.contains(e.target)&&!e.target.closest('.theme-btn'))closeThemePanel();});
// â”€â”€ åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ â”€â”€
function showSync(on){
  var el=document.getElementById('syncIndicator');
  if(!el){el=document.createElement('div');el.id='syncIndicator';el.style.cssText='position:fixed;bottom:96px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);font-size:12px;padding:5px 14px;border-radius:20px;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;';document.body.appendChild(el);}
  el.textContent='åŒæœŸä¸­â€¦';el.style.opacity=on?'1':'0';
}
// â”€â”€ åˆæœŸãƒ­ãƒ¼ãƒ‰ â”€â”€
async function init(){
  showSync(true);
  try {
    // tasks: repeat/linked_habitã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã«å‚™ãˆã¦å®‰å…¨ã«èª­ã¿è¾¼ã¿
    var tr=await sb.from('tasks').select('*').order('created_at',{ascending:true});
    if(!tr.error&&tr.data){
      tasks=tr.data.map(function(r){
        return{id:r.id,title:r.title||'',memo:r.memo||'',date:r.date||'',time:r.time||'',
          notif:!!r.notif,tag:r.tag||'',urgent:!!r.urgent,done:!!r.done,
          repeat:r.repeat||'none',linked_habit:r.linked_habit||null,
          createdAt:new Date(r.created_at)};
      });
    }
    // habit_items
    var hr=await sb.from('habit_items').select('*').order('sort_order',{ascending:true});
    if(!hr.error&&hr.data){
      if(hr.data.length){
        habitDefs=hr.data.map(function(r){return{id:String(r.id),emoji:r.emoji||'',name:r.name};});
      }else{
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒç©º â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ¿å…¥
        var defaults=[{emoji:'',name:'ç¿’æ…£1',sort_order:0}];
        var dr=await sb.from('habit_items').insert(defaults).select();
        if(!dr.error&&dr.data)habitDefs=dr.data.map(function(r){return{id:String(r.id),emoji:'',name:r.name};});
      }
    }
    selGraphHabit=habitDefs[0]?habitDefs[0].id:null;
    // habit_logs
    var lr=await sb.from('habit_logs').select('item_id,log_date');
    if(!lr.error&&lr.data){
      habitLogs={};
      lr.data.forEach(function(r){var key=String(r.item_id);if(!habitLogs[key])habitLogs[key]={};habitLogs[key][r.log_date]=true;});
    }
  } catch(e) {
    console.error('init error:', e);
  }
  showSync(false);
  try { processRepeatTasks(); } catch(e){ console.error('repeat error:',e); }
  // ã‚½ãƒ¼ãƒˆãƒ»ã‚¿ãƒ–çŠ¶æ…‹ã‚’å¾©å…ƒ
  if(sortByDate){document.getElementById('sortLabel').textContent='ä½œæˆé †';document.getElementById('sortBtn').classList.add('active');}
  var savedTab=localStorage.getItem('atode_tab')||'all';
  currentTab=savedTab;
  var tabEl=document.getElementById('tab-'+savedTab);
  if(tabEl){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});tabEl.classList.add('active');}
  render();
  renderHabitTable();
  scheduleAll();
}

// ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯å‡¦ç†ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚1å›ã®ã¿ã€é‡è¤‡é˜²æ­¢ï¼‰
async function processRepeatTasks(){
  var today=new Date();today.setHours(0,0,0,0);
  var td=todayStr();
  // dailyã®ã¿å‡¦ç†ï¼ˆweekly/monthlyã¯Supabaseå´ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ï¼‰
  var toUpdate=[];
  var toInsertWeekly=[];
  var toInsertMonthly=[];
  for(var i=0;i<tasks.length;i++){
    var t=tasks[i];
    if(!t.repeat||t.repeat==='none')continue;
    if(!t.date)continue;
    var taskDate=new Date(t.date+'T00:00');taskDate.setHours(0,0,0,0);
    if(taskDate>=today)continue; // ã¾ã æœŸé™æ¥ã¦ãªã„
    if(t.repeat==='daily'&&!t.done){
      toUpdate.push(t);
    } else if(t.repeat==='weekly'&&t.done){
      // å®Œäº†æ¸ˆã¿weeklyã®ã¿æ¬¡ã‚’ä½œæˆ
      var nextD=new Date(taskDate);nextD.setDate(taskDate.getDate()+7);
      var nd=dateStr(nextD);
      var exists=tasks.some(function(x){return x.title===t.title&&x.repeat==='weekly'&&!x.done&&x.id!==t.id;});
      if(!exists)toInsertWeekly.push({src:t,nd:nd});
    } else if(t.repeat==='monthly'&&t.done){
      // å®Œäº†æ¸ˆã¿monthlyã®ã¿æ¬¡ã‚’ä½œæˆ
      var nextD=new Date(taskDate);nextD.setMonth(taskDate.getMonth()+1);
      var nd=dateStr(nextD);
      var exists=tasks.some(function(x){return x.title===t.title&&x.repeat==='monthly'&&!x.done&&x.id!==t.id;});
      if(!exists)toInsertMonthly.push({src:t,nd:nd});
    }
  }
  for(var i=0;i<toUpdate.length;i++){
    var t=toUpdate[i];
    t.date=td;
    await sb.from('tasks').update({date:td,done:false}).eq('id',t.id);
  }
  var inserts=toInsertWeekly.concat(toInsertMonthly);
  for(var i=0;i<inserts.length;i++){
    var src=inserts[i].src,nd=inserts[i].nd;
    var res=await sb.from('tasks').insert([{title:src.title,memo:src.memo,date:nd,time:src.time,notif:false,tag:src.tag,urgent:src.urgent,done:false,repeat:src.repeat,linked_habit:src.linked_habit||null}]).select().single();
    if(!res.error){tasks.push({id:res.data.id,title:src.title,memo:src.memo||'',date:nd,time:src.time||'',notif:false,tag:src.tag||'',urgent:src.urgent,done:false,repeat:src.repeat,linked_habit:src.linked_habit||null,createdAt:new Date(res.data.created_at)});}
  }
}

init();
</script>
</body>
</html>
